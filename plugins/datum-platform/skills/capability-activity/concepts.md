# Activity Concepts

This document explains the core concepts and resource types in the Activity system.

## System Architecture

The Activity system transforms raw audit logs and Kubernetes events into human-readable activity timelines:

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Kubernetes    │     │    Activity     │     │    Activity     │
│   API Server    │────▶│   Translator    │────▶│    Storage      │
│  (Audit Logs)   │     │   (Policies)    │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                │                       │
┌─────────────────┐             │                       │
│   Controllers   │             │                       ▼
│   (K8s Events)  │─────────────┘                ┌─────────────────┐
└─────────────────┘                              │  Activity API   │
                                                 │  (Queries)      │
                                                 └─────────────────┘
```

### Two Event Sources

1. **Audit Logs** — Automatically generated by the Kubernetes API server for every API operation (create, update, delete, etc.). No code required.

2. **Kubernetes Events** — Emitted by controllers using the Kubernetes event recorder. Controllers must explicitly emit events for state transitions, async operations, and error conditions. See `emitting-events.md` for implementation.

**Key insight**: Services don't emit activities directly. They:
1. Emit Kubernetes events from controllers (for async state changes)
2. Define **ActivityPolicy** resources that translate both audit logs and events into human-readable summaries

---

## Resource Types

### Activity (Read-Only)

An Activity is a human-readable record of something that happened in the system. Activities are query results—you don't create them directly.

```yaml
apiVersion: activity.miloapis.com/v1alpha1
kind: Activity
metadata:
  name: activity-abc123
  creationTimestamp: "2024-01-15T10:30:00Z"
spec:
  # Human-readable description of what happened
  summary: "alice@example.com created HTTPProxy my-proxy"

  # Who initiated this action (human or system)
  changeSource: human  # or "system"

  # Who performed the action
  actor:
    type: user         # user, serviceaccount, controller
    name: alice@example.com
    uid: "user-123"
    email: alice@example.com

  # What resource was affected
  resource:
    apiGroup: otherservice.miloapis.com
    apiVersion: v1alpha1
    kind: HTTPProxy
    name: my-proxy
    namespace: my-project
    uid: "resource-456"

  # Clickable links in the summary
  links:
    - marker: "HTTPProxy my-proxy"  # Text to highlight
      resource:
        apiGroup: otherservice.miloapis.com
        kind: HTTPProxy
        name: my-proxy
        namespace: my-project

  # Multi-tenant context
  tenant:
    type: project      # global, organization, project, user
    name: my-project

  # Link back to source data
  origin:
    type: audit        # audit or event
    id: "audit-789"

  # Optional: field-level changes
  changes:
    - field: "spec.virtualhost.fqdn"
      old: "old.example.com"
      new: "new.example.com"
```

#### Actor Types

| Type | Description | Example |
|------|-------------|---------|
| `user` | Human user authenticated via OIDC/SSO | alice@example.com |
| `serviceaccount` | Kubernetes service account | system:serviceaccount:default:mysa |
| `controller` | Kubernetes controller | deployment-controller |

#### Change Source

| Value | Meaning | How Determined |
|-------|---------|----------------|
| `human` | User-initiated action | Actor is a user (not system:*) |
| `system` | Controller/automation | Actor starts with system: |

---

### ActivityPolicy (Cluster-Scoped)

An ActivityPolicy defines how audit logs and events for a specific resource type are translated into Activity objects.

```yaml
apiVersion: activity.miloapis.com/v1alpha1
kind: ActivityPolicy
metadata:
  name: networking-httpproxy
spec:
  # Target resource type
  resource:
    apiGroup: otherservice.miloapis.com
    kind: HTTPProxy

  # Rules for translating audit logs
  auditRules:
    - match: "audit.verb == 'create'"
      summary: "{{ actor }} created {{ link(kind + ' ' + audit.objectRef.name, audit.responseObject) }}"

    - match: "audit.verb == 'delete'"
      summary: "{{ actor }} deleted {{ kind }} {{ audit.objectRef.name }}"

    - match: "audit.verb in ['update', 'patch'] && audit.objectRef.subresource == ''"
      summary: "{{ actor }} updated {{ link(kind + ' ' + audit.objectRef.name, audit.objectRef) }}"

  # Rules for translating Kubernetes events
  eventRules:
    - match: "event.reason == 'Programmed'"
      summary: "{{ link(kind + ' ' + event.regarding.name, event.regarding) }} is now programmed"
```

#### Rule Structure

Each rule has:
- **match**: CEL expression returning boolean (determines if rule applies)
- **summary**: CEL template with `{{ }}` expressions (generates summary text)

#### Rule Evaluation

1. When an audit log or event arrives, the system finds policies matching the resource type
2. Rules are evaluated in order; first matching rule wins
3. The summary template is rendered with context variables
4. The resulting Activity is stored

---

### ActivityQuery (Ephemeral)

An ActivityQuery searches historical activities. Create it to execute a query; the results appear in the status.

```yaml
apiVersion: activity.miloapis.com/v1alpha1
kind: ActivityQuery
metadata:
  name: recent-changes
spec:
  # Time range (required)
  startTime: "now-7d"           # Relative: now-{n}{s|m|h|d|w}
  endTime: "now"                # Or absolute: 2024-01-15T00:00:00Z

  # Optional filters
  changeSource: "human"         # human or system
  namespace: "my-project"       # Filter by namespace
  apiGroup: "otherservice.miloapis.com"  # Filter by API group
  resourceKind: "HTTPProxy"     # Filter by kind
  actorName: "alice@example.com" # Filter by actor

  # Advanced filtering
  filter: "spec.actor.type == 'user'"  # CEL expression
  search: "created"             # Full-text search on summary

  # Pagination
  limit: 100                    # Results per page (max 1000)
  continue: ""                  # Pagination cursor from previous query

status:
  # Query results
  results:
    - # Activity objects...

  # Pagination
  continue: "eyJhbGciOiJ..."    # Non-empty means more results

  # Resolved time range
  effectiveStartTime: "2024-01-08T00:00:00Z"
  effectiveEndTime: "2024-01-15T00:00:00Z"
```

#### Time Formats

| Format | Example | Description |
|--------|---------|-------------|
| Relative | `now-7d` | 7 days ago from now |
| Relative | `now-2h` | 2 hours ago |
| Relative | `now-30m` | 30 minutes ago |
| Absolute | `2024-01-15T00:00:00Z` | RFC3339 timestamp |

#### Filter Expressions

CEL expressions for the `filter` field:

```yaml
# By actor
filter: "spec.actor.name == 'alice@example.com'"
filter: "spec.actor.type == 'user'"
filter: "!spec.actor.name.startsWith('system:')"

# By resource
filter: "spec.resource.kind == 'HTTPProxy'"
filter: "spec.resource.kind in ['Deployment', 'StatefulSet']"

# By change source
filter: "spec.changeSource == 'human'"

# By summary content
filter: "spec.summary.contains('created')"

# Combined
filter: "spec.actor.type == 'user' && spec.resource.kind == 'HTTPProxy'"
```

---

### ActivityFacetQuery (Ephemeral)

An ActivityFacetQuery retrieves distinct values for specific fields, useful for building filter UIs.

```yaml
apiVersion: activity.miloapis.com/v1alpha1
kind: ActivityFacetQuery
metadata:
  name: filter-options
spec:
  # Time range
  timeRange:
    start: "now-30d"
    end: "now"

  # Optional: pre-filter activities
  filter: "spec.changeSource == 'human'"

  # Fields to get facets for
  facets:
    - field: spec.actor.name
      limit: 20
    - field: spec.resource.kind
    - field: spec.resource.namespace
    - field: spec.changeSource

status:
  facets:
    - field: spec.actor.name
      values:
        - value: alice@example.com
          count: 142
        - value: bob@example.com
          count: 89
        - value: carol@example.com
          count: 45

    - field: spec.resource.kind
      values:
        - value: HTTPProxy
          count: 231
        - value: Instance
          count: 156
        - value: Deployment
          count: 98

    - field: spec.changeSource
      values:
        - value: human
          count: 276
        - value: system
          count: 1842
```

#### Supported Facet Fields

| Field | Description |
|-------|-------------|
| `spec.actor.name` | Actor display names |
| `spec.actor.type` | Actor types (user, serviceaccount, controller) |
| `spec.resource.apiGroup` | API groups |
| `spec.resource.kind` | Resource kinds |
| `spec.resource.namespace` | Namespaces |
| `spec.changeSource` | Change sources (human, system) |

---

### AuditLogQuery (Ephemeral)

An AuditLogQuery provides direct access to raw Kubernetes audit logs, useful for debugging or compliance.

```yaml
apiVersion: activity.miloapis.com/v1alpha1
kind: AuditLogQuery
metadata:
  name: raw-audit-logs
spec:
  # Time range
  startTime: "now-1h"
  endTime: "now"

  # Optional filters
  verb: "create"                # create, update, patch, delete, etc.
  resource:
    apiGroup: otherservice.miloapis.com
    kind: HTTPProxy
  namespace: "my-project"
  username: "alice@example.com"

  # Pagination
  limit: 100

status:
  results:
    - # Raw audit.Event objects
      verb: create
      objectRef:
        apiGroup: otherservice.miloapis.com
        resource: httpproxies
        name: my-proxy
        namespace: my-project
      user:
        username: alice@example.com
      responseStatus:
        code: 201
```

---

### EventFacetQuery (Ephemeral)

An EventFacetQuery retrieves distinct values from Kubernetes events, useful for building event filter UIs.

```yaml
apiVersion: activity.miloapis.com/v1alpha1
kind: EventFacetQuery
metadata:
  name: event-filter-options
spec:
  timeRange:
    start: "now-7d"
    end: "now"

  facets:
    - field: involvedObject.kind
    - field: involvedObject.namespace
    - field: reason
      limit: 20
    - field: type
    - field: source.component

status:
  facets:
    - field: reason
      values:
        - value: Ready
          count: 523
        - value: Failed
          count: 89
        - value: Progressing
          count: 312

    - field: type
      values:
        - value: Normal
          count: 824
        - value: Warning
          count: 100
```

#### Supported Event Facet Fields

| Field | Description |
|-------|-------------|
| `involvedObject.kind` | Resource kinds events are about |
| `involvedObject.namespace` | Namespaces of involved objects |
| `reason` | Event reason codes (Ready, Failed, etc.) |
| `type` | Event types (Normal, Warning) |
| `source.component` | Source controller/component |
| `namespace` | Event namespace |

---

### PolicyPreview (Ephemeral)

A PolicyPreview tests ActivityPolicy rules against sample inputs without deploying the policy.

```yaml
apiVersion: activity.miloapis.com/v1alpha1
kind: PolicyPreview
metadata:
  name: test-my-policy
spec:
  # Policy to test (inline)
  policy:
    resource:
      apiGroup: myservice.miloapis.com
      kind: MyResource
    auditRules:
      - match: "audit.verb == 'create'"
        summary: "{{ actor }} created {{ kind }}"

  # Sample inputs to test against
  inputs:
    - type: audit
      audit:
        verb: create
        objectRef:
          apiGroup: myservice.miloapis.com
          resource: myresources
          name: test-resource
        user:
          username: alice@example.com

    - type: event
      event:
        reason: Ready
        regarding:
          apiGroup: myservice.miloapis.com
          kind: MyResource
          name: test-resource

status:
  results:
    - inputIndex: 0
      matched: true
      ruleIndex: 0
      activity:
        spec:
          summary: "alice@example.com created MyResource"
          actor:
            name: alice@example.com
            type: user

    - inputIndex: 1
      matched: false
      error: "No matching event rule"
```

---

## CEL Expression Reference

### Match Expressions

Match expressions are pure CEL returning boolean:

```yaml
# Audit context
audit.verb == 'create'
audit.verb in ['update', 'patch']
audit.objectRef.subresource == 'status'
audit.objectRef.subresource == ''
audit.user.username.startsWith('system:')
audit.responseStatus.code >= 400

# Event context
event.reason == 'Ready'
event.type == 'Warning'
event.regarding.name == 'my-resource'
```

### Summary Templates

Summary templates use `{{ }}` delimiters with CEL inside:

```yaml
# Simple variables
summary: "{{ actor }} created {{ kind }}"

# Concatenation
summary: "{{ actor }} created {{ kind + ' ' + audit.objectRef.name }}"

# Conditional
summary: "{{ audit.user.username.startsWith('system:') ? 'System' : actor }} updated {{ kind }}"

# link() function
summary: "{{ link(kind + ' ' + audit.objectRef.name, audit.responseObject) }}"
```

### Built-in Variables

| Variable | Context | Type | Description |
|----------|---------|------|-------------|
| `actor` | Both | string | Resolved display name |
| `kind` | Both | string | Resource kind from policy |
| `audit` | Audit | object | Full audit.Event |
| `audit.verb` | Audit | string | API verb |
| `audit.objectRef` | Audit | object | Target resource |
| `audit.user` | Audit | object | Authenticated user |
| `audit.responseObject` | Audit | object | Created/updated resource |
| `audit.responseStatus` | Audit | object | HTTP response |
| `event` | Event | object | Full core/v1 Event |
| `event.reason` | Event | string | Event reason code |
| `event.type` | Event | string | Normal or Warning |
| `event.message` | Event | string | Event message |
| `event.regarding` | Event | object | Target resource |
| `event.annotations` | Event | map | Event annotations (for structured data) |

### Accessing Event Annotations

Controllers can include structured data in event annotations for user-friendly messaging. Access annotations using map syntax:

```yaml
# Access annotation value
event.annotations['activity.miloapis.com/display-name']

# Check if annotation exists
has(event.annotations['activity.miloapis.com/display-name'])

# Use in summary template
summary: "{{ event.annotations['activity.miloapis.com/display-name'] }} is ready"

# With fallback
summary: "{{ has(event.annotations['activity.miloapis.com/display-name']) ? event.annotations['activity.miloapis.com/display-name'] : event.regarding.name }} is ready"
```

See `emitting-events.md` for complete annotation patterns and conventions.

### The link() Function

Creates clickable resource references:

```yaml
# link(displayText, resourceReference)
summary: "{{ link('MyResource test', audit.responseObject) }}"
```

The second argument must be an object with apiGroup, kind, name, namespace fields.

---

## Multi-Tenancy

Activities are scoped to tenants for isolation:

```yaml
spec:
  tenant:
    type: project      # Tenant level
    name: my-project   # Tenant identifier
```

### Tenant Levels

| Type | Description | Visibility |
|------|-------------|------------|
| `global` | Platform-wide activities | Platform admins |
| `organization` | Organization-scoped | Org members |
| `project` | Project-scoped | Project members |
| `user` | User-specific | Individual user |

Tenant context is automatically determined from the resource's namespace hierarchy.

---

## Data Flow Summary

1. **API Operation**: User creates/updates/deletes a resource via kubectl or API
2. **Audit Log**: Kubernetes API server generates an audit log entry
3. **Event Capture**: Activity system receives the audit log
4. **Policy Match**: System finds ActivityPolicy for the resource type
5. **Rule Evaluation**: First matching rule's summary template is rendered
6. **Storage**: Activity is stored for efficient querying
7. **Query**: Users retrieve via ActivityQuery or watch API
