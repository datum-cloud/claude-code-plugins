# Runbook Promotion

Rules and procedures for automatically promoting patterns to agent runbooks.

## Promotion Criteria

A pattern is eligible for promotion when ALL of the following are true:

| Criterion | Threshold | Rationale |
|-----------|-----------|-----------|
| Occurrence count | >= 3 | Avoids promoting one-off issues |
| Confidence score | >= 0.6 | Ensures pattern is significant |
| Has description | Non-empty | Must be understandable |
| Has affected agents | Non-empty | Must know where to promote |
| Not already promoted | Check flag | Avoid duplicates |

## Promotion Workflow

### Step 1: Identify Eligible Patterns

```python
def get_promotable_patterns(registry):
    eligible = []
    for pattern in registry["patterns"].values():
        if (pattern["count"] >= 3 and
            pattern["confidence"] >= 0.6 and
            pattern["description"] and
            pattern["affected_agents"] and
            not pattern.get("promoted_to_runbook", False)):
            eligible.append(pattern)
    return eligible
```

### Step 2: Generate Runbook Entry

For each eligible pattern, generate a markdown entry:

```markdown
### {Pattern Name} (Auto-generated)

**Confidence**: {score} | **Occurrences**: {count} | **Trend**: {trend} | **Last seen**: {date}

**Context**: {When this pattern typically appears}

**{Pattern|Anti-Pattern}**: {Description of what to do or avoid}

**Example**:
```{language}
{Code example extracted from findings, or fix template}
```

**Why this matters**: {Impact based on severity - blocking issues cause build failures, etc.}

**Learned from**:
- {PR/feature reference 1}
- {PR/feature reference 2}
- {PR/feature reference 3}

**Affected services**: {List of services where this was found}

*Auto-generated by learning engine on {date}. Review and refine as needed.*

---
```

### Step 3: Determine Target Runbooks

Map patterns to agent runbooks based on:

1. **Primary agent**: The agent most likely to prevent this issue
2. **Review agent**: code-reviewer always gets patterns for awareness
3. **Related agents**: Agents that work in the same area

| Pattern Category | Primary Agent | Related Agents |
|------------------|---------------|----------------|
| correctness (types) | api-dev | code-reviewer, test-engineer |
| correctness (UI) | frontend-dev | code-reviewer |
| security | api-dev, sre | code-reviewer |
| convention | api-dev, frontend-dev | code-reviewer |
| completeness (capabilities) | api-dev | code-reviewer |
| performance | api-dev, sre | code-reviewer |
| infrastructure | sre | code-reviewer |

### Step 4: Update Runbook Files

Append to `.claude/skills/runbooks/{agent}/RUNBOOK.md`:

```python
def update_runbook(agent, pattern, entry):
    runbook_path = f".claude/skills/runbooks/{agent}/RUNBOOK.md"

    # Read existing runbook
    content = read_file(runbook_path)

    # Find the appropriate section
    if is_anti_pattern(pattern):
        section = "## Anti-Patterns"
    else:
        section = "## Patterns That Work"

    # Check if pattern already exists (by name)
    if pattern["name"] in content:
        # Update existing entry
        content = update_existing_entry(content, pattern, entry)
    else:
        # Append new entry after section header
        content = insert_after_section(content, section, entry)

    # Add auto-generated section if not present
    if "## Auto-Generated Patterns" not in content:
        content = add_auto_generated_section(content)

    write_file(runbook_path, content)
```

### Step 5: Mark as Promoted

Update pattern registry to prevent re-promotion:

```python
def mark_promoted(registry, pattern_name, agents):
    pattern = registry["patterns"][pattern_name]
    pattern["promoted_to_runbook"] = True
    pattern["runbook_agents"] = agents
    pattern["promoted_date"] = now()
    save_registry(registry)
```

## Runbook Structure

Runbooks should have this structure to support auto-generation:

```markdown
# {Agent Name} Runbook

Last updated: {date}
Auto-generated patterns: {count}

## Patterns That Work

### Manual Pattern 1
...

### Manual Pattern 2
...

## Anti-Patterns

### Manual Anti-Pattern 1
...

## Auto-Generated Patterns

*The following patterns were automatically extracted from review findings and session learnings.*

### {Auto Pattern 1} (Auto-generated)
...

### {Auto Pattern 2} (Auto-generated)
...

## Service-Specific Notes

...

## Common Mistakes

...
```

## Update Frequency

| Trigger | Action |
|---------|--------|
| `/evolve` command | Full analysis and promotion |
| After code review | Incremental pattern update |
| Weekly (scheduled) | Trend analysis and alerts |

## Conflict Resolution

When auto-generated patterns conflict with manual entries:

1. **Same pattern name**: Keep manual entry, update statistics only
2. **Contradictory advice**: Flag for human review, don't auto-update
3. **Outdated auto-entry**: Replace if manual entry is newer

## Promotion Log

Track all promotions in `.claude/patterns/promotion-log.jsonl`:

```json
{
  "date": "2025-01-15T10:30:00Z",
  "pattern": "missing-status-condition",
  "confidence": 0.85,
  "occurrences": 7,
  "promoted_to": ["api-dev", "code-reviewer"],
  "entry_type": "anti-pattern",
  "trigger": "evolve_command"
}
```

## Demotion Rules

Patterns can be demoted (removed from runbooks) when:

1. **Resolved**: No occurrences in 90+ days AND confidence drops below 0.3
2. **Superseded**: A more specific pattern replaces a general one
3. **Invalid**: Manual review marks pattern as incorrect

Demotion process:
1. Move entry to "Archived Patterns" section
2. Update pattern registry: `"demoted": true, "demoted_date": "..."`
3. Log demotion reason

## Quality Assurance

To maintain runbook quality:

1. **Review threshold**: Patterns with confidence > 0.9 are added directly
2. **Draft threshold**: Patterns with confidence 0.6-0.9 are marked as drafts
3. **Human review**: Drafts should be reviewed within 7 days
4. **Staleness check**: Patterns not seen in 180 days are flagged for review
