#!/bin/bash
# Scaffold InsightPolicy resources for a service
# Usage: scaffold-insights.sh <resource-name> <api-group>
# Example: scaffold-insights.sh MyResource myservice.miloapis.com

set -e

RESOURCE_NAME="${1:-MyResource}"
API_GROUP="${2:-myservice.miloapis.com}"
RESOURCE_LOWER=$(echo "$RESOURCE_NAME" | tr '[:upper:]' '[:lower:]')
SERVICE_NAME=$(echo "$API_GROUP" | cut -d. -f1)

if [ -z "$RESOURCE_NAME" ] || [ "$RESOURCE_NAME" == "MyResource" ]; then
    echo "Usage: scaffold-insights.sh <resource-name> <api-group>"
    echo "Example: scaffold-insights.sh VirtualMachine myservice.miloapis.com"
    exit 1
fi

echo "Scaffolding InsightPolicy for $RESOURCE_NAME..."

# Create insights directory
mkdir -p config/insights

# Generate InsightPolicy file
cat > "config/insights/${RESOURCE_LOWER}-policies.yaml" << EOF
# InsightPolicy for ${RESOURCE_NAME}
# Generated by scaffold-insights.sh
apiVersion: insights.miloapis.com/v1alpha1
kind: InsightPolicy
metadata:
  name: ${SERVICE_NAME}-${RESOURCE_LOWER}
  namespace: ${SERVICE_NAME}-system
spec:
  targetSelector:
    apiVersion: ${API_GROUP}/v1alpha1
    kind: ${RESOURCE_NAME}
  rules:
    # Configuration validation example
    - name: missing-required-field
      condition: |
        !has(object.spec.requiredField) ||
        object.spec.requiredField == ''
      severity: critical
      category: configuration
      message: "{{ object.kind }} {{ object.metadata.name }} is missing required field"
      description: |
        The requiredField must be set for the resource to function correctly.

        To fix: Set spec.requiredField to an appropriate value.

    # Health check example
    - name: not-ready-prolonged
      condition: |
        has(object.status.conditions) &&
        object.status.conditions.exists(c,
          c.type == 'Ready' &&
          c.status == 'False' &&
          timestamp(c.lastTransitionTime) < now() - duration('15m')
        )
      severity: warning
      category: health
      message: "{{ object.kind }} {{ object.metadata.name }} has been not ready for over 15 minutes"
      description: |
        The resource has been in a not-ready state for an extended period.
        Check the status conditions and logs for more details.

    # Security example (uncomment and customize)
    # - name: insecure-configuration
    #   condition: "object.spec.tlsEnabled == false"
    #   severity: critical
    #   category: security
    #   message: "{{ object.kind }} {{ object.metadata.name }} has TLS disabled"
    #   description: "TLS should be enabled for production workloads."

    # Optimization example (uncomment and customize)
    # - name: oversized-resources
    #   condition: |
    #     has(object.status.metrics) &&
    #     object.status.metrics.utilizationPercent < 10
    #   severity: info
    #   category: optimization
    #   message: "{{ object.kind }} {{ object.metadata.name }} appears underutilized"
    #   description: "Consider reducing resource allocation to save costs."
    #   ttlSeconds: 604800  # Re-evaluate weekly
EOF

echo "Created config/insights/${RESOURCE_LOWER}-policies.yaml"

# Create or update kustomization.yaml
if [ ! -f "config/insights/kustomization.yaml" ]; then
    cat > "config/insights/kustomization.yaml" << EOF
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ${RESOURCE_LOWER}-policies.yaml
EOF
    echo "Created config/insights/kustomization.yaml"
else
    # Add to existing kustomization if not already present
    if ! grep -q "${RESOURCE_LOWER}-policies.yaml" config/insights/kustomization.yaml; then
        echo "  - ${RESOURCE_LOWER}-policies.yaml" >> config/insights/kustomization.yaml
        echo "Updated config/insights/kustomization.yaml"
    fi
fi

echo ""
echo "=== Scaffolded Insights Integration ==="
echo ""
echo "Next steps:"
echo "  1. Review and customize the rules in config/insights/${RESOURCE_LOWER}-policies.yaml"
echo "  2. Add more rules specific to your resource type"
echo "  3. Include insights in your base kustomization:"
echo ""
echo "     # config/base/kustomization.yaml"
echo "     components:"
echo "       - ../insights"
echo ""
echo "  4. Test the policies:"
echo "     kubectl apply -f config/insights/"
echo "     kubectl get insightpolicies -n ${SERVICE_NAME}-system"
echo ""
echo "  5. Run validation:"
echo "     ./scripts/validate-insights.sh"
echo ""
